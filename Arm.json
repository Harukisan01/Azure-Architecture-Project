{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location for all resources"
            }
        },
        "prefix": {
            "type": "string",
            "defaultValue": "arch",
            "metadata": {
                "description": "Prefix for resource names"
            }
        },
        "adminUsername": {
            "type": "string",
            "defaultValue": "azureuser",
            "metadata": {
                "description": "Admin username for VMSS"
            }
        },
        "adminPassword": {
            "type": "securestring",
            "defaultValue": "P@ssw0rd1234!",
            "metadata": {
                "description": "Admin password for VMSS"
            }
        }
    },
    "variables": {
        "vnetName": "[concat(parameters('prefix'), '-vnet')]",
        "vnetId": "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]",
        "subnetAgwName": "AppGatewaySubnet",
        "subnetAgwPrefix": "10.0.1.0/24",
        "subnetAppServiceName": "AppServiceSubnet",
        "subnetAppServicePrefix": "10.0.2.0/24",
        "subnetBackendName": "BackendSubnet",
        "subnetBackendPrefix": "10.0.3.0/24",
        "subnetBastionName": "AzureBastionSubnet",
        "subnetBastionPrefix": "10.0.4.0/24",
        "agwName": "[concat(parameters('prefix'), '-agw-front')]",
        "pipAgwName": "[concat(parameters('prefix'), '-pip-agw')]",
        "appServicePlanName": "plan-az104",
        "appServiceName": "[concat(parameters('prefix'), '-app')]",
        "storageAccountName": "[concat(parameters('prefix'), 'store')]",
        "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
        "privateEndpointName": "[concat(parameters('prefix'), '-pe-storage')]",
        "privateDnsZoneName": "privatelink.blob.core.windows.net",
        "vmssName": "[concat(parameters('prefix'), '-vmss-backend')]",
        "lbName": "[concat(parameters('prefix'), '-lb-vmss')]",
        "bastionName": "[concat(parameters('prefix'), '-bastion')]",
        "pipBastionName": "[concat(parameters('prefix'), '-pip-bastion')]",
        "lawName": "[concat(parameters('prefix'), '-law')]",
        "lawId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('lawName'))]",
        "rsvName": "[concat(parameters('prefix'), '-rsv')]"
    },
    "resources": [
        {
            "type": "Microsoft.OperationalInsights/workspaces",
            "apiVersion": "2021-06-01",
            "name": "[variables('lawName')]",
            "location": "[parameters('location')]",
            "properties": {
                "sku": {
                    "name": "PerGB2018"
                },
                "retentionInDays": 30
            }
        },
        {
            "type": "Microsoft.RecoveryServices/vaults",
            "apiVersion": "2022-04-01",
            "name": "[variables('rsvName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "RS0",
                "tier": "Standard"
            },
            "properties": {}
        },
        {
            "type": "Microsoft.RecoveryServices/vaults/backupPolicies",
            "apiVersion": "2021-01-01",
            "name": "[concat(variables('rsvName'), '/DailyBackupPolicy')]",
            "dependsOn": [
                "[resourceId('Microsoft.RecoveryServices/vaults', variables('rsvName'))]"
            ],
            "properties": {
                "backupManagementType": "AzureWebApp",
                "schedulePolicy": {
                    "scheduleRunFrequency": "Daily",
                    "scheduleRunTimes": [
                        "2023-01-01T22:00:00Z"
                    ],
                    "schedulePolicyType": "AzureWebAppSchedule"
                },
                "retentionPolicy": {
                    "dailySchedule": {
                        "retentionTimes": [
                            "2023-01-01T22:00:00Z"
                        ],
                        "retentionDuration": {
                            "count": 30,
                            "durationType": "Days"
                        }
                    },
                    "retentionPolicyType": "AzureWebAppRetentionPolicy"
                }
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2022-07-01",
            "name": "[variables('pipAgwName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "publicIPAllocationMethod": "Static"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2022-07-01",
            "name": "[variables('vnetName')]",
            "location": "[parameters('location')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "10.0.0.0/16"
                    ]
                },
                "subnets": [
                    {
                        "name": "[variables('subnetAgwName')]",
                        "properties": {
                            "addressPrefix": "[variables('subnetAgwPrefix')]"
                        }
                    },
                    {
                        "name": "[variables('subnetAppServiceName')]",
                        "properties": {
                            "addressPrefix": "[variables('subnetAppServicePrefix')]",
                            "delegations": [
                                {
                                    "name": "delegation",
                                    "properties": {
                                        "serviceName": "Microsoft.Web/serverFarms"
                                    }
                                }
                            ]
                        }
                    },
                    {
                        "name": "[variables('subnetBackendName')]",
                        "properties": {
                            "addressPrefix": "[variables('subnetBackendPrefix')]"
                        }
                    },
                    {
                        "name": "[variables('subnetBastionName')]",
                        "properties": {
                            "addressPrefix": "[variables('subnetBastionPrefix')]"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/privateDnsZones",
            "apiVersion": "2020-06-01",
            "name": "[variables('privateDnsZoneName')]",
            "location": "global"
        },
        {
            "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
            "apiVersion": "2020-06-01",
            "name": "[concat(variables('privateDnsZoneName'), '/linkToVnet')]",
            "location": "global",
            "properties": {
                "registrationEnabled": false,
                "virtualNetwork": {
                    "id": "[variables('vnetId')]"
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            ]
        },
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2022-05-01",
            "name": "[variables('storageAccountName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard_LRS"
            },
            "kind": "StorageV2",
            "properties": {
                "publicNetworkAccess": "Disabled",
                "supportsHttpsTrafficOnly": true,
                "minimumTlsVersion": "TLS1_2"
            }
        },
        {
            "type": "Microsoft.Network/privateEndpoints",
            "apiVersion": "2022-07-01",
            "name": "[variables('privateEndpointName')]",
            "location": "[parameters('location')]",
            "properties": {
                "privateLinkServiceConnections": [
                    {
                        "name": "storageConnection",
                        "properties": {
                            "privateLinkServiceId": "[variables('storageAccountId')]",
                            "groupIds": [
                                "blob"
                            ]
                        }
                    }
                ],
                "subnet": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetBackendName'))]"
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            ]
        },
        {
            "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
            "apiVersion": "2022-07-01",
            "name": "[concat(variables('privateEndpointName'), '/default')]",
            "properties": {
                "privateDnsZoneConfigs": [
                    {
                        "name": "dnsConfig",
                        "properties": {
                            "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', variables('privateDnsZoneName'))]"
                        }
                    }
                ]
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
            ]
        },
        {
            "type": "Microsoft.Web/serverfarms",
            "apiVersion": "2022-03-01",
            "name": "[variables('appServicePlanName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "P1v2",
                "tier": "PremiumV2"
            },
            "properties": {
                "reserved": true
            }
        },
        {
            "type": "Microsoft.Web/sites",
            "apiVersion": "2022-03-01",
            "name": "[variables('appServiceName')]",
            "location": "[parameters('location')]",
            "kind": "app,linux",
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "siteConfig": {
                    "linuxFxVersion": "DOCKER|nginx:latest",
                    "vnetRouteAllEnabled": true
                },
                "httpsOnly": true
            },
            "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
            ],
            "resources": [
                {
                    "type": "networkConfig",
                    "apiVersion": "2022-03-01",
                    "name": "virtualNetwork",
                    "properties": {
                        "subnetResourceId": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetAppServiceName'))]"
                    },
                    "dependsOn": [
                        "[resourceId('Microsoft.Web/sites', variables('appServiceName'))]"
                    ]
                },
                {
                    "type": "config",
                    "apiVersion": "2022-03-01",
                    "name": "logs",
                    "properties": {
                        "applicationLogs": {
                            "fileSystem": {
                                "level": "Information"
                            }
                        },
                        "httpLogs": {
                            "fileSystem": {
                                "enabled": true,
                                "retentionInDays": 30,
                                "retentionInMb": 100
                            }
                        }
                    },
                    "dependsOn": [
                        "[resourceId('Microsoft.Web/sites', variables('appServiceName'))]"
                    ]
                }
            ]
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2022-04-01",
            "name": "[guid(variables('appServiceName'), 'StorageBlobDataReader')]",
            "scope": "[variables('storageAccountId')]",
            "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]",
                "principalId": "[reference(variables('appServiceName'), '2022-03-01', 'Full').identity.principalId]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('appServiceName'))]"
            ]
        },
        {
            "type": "Microsoft.Insights/diagnosticSettings",
            "apiVersion": "2021-05-01-preview",
            "scope": "[concat('Microsoft.Web/sites/', variables('appServiceName'))]",
            "name": "AppServiceLogs",
            "properties": {
                "workspaceId": "[variables('lawId')]",
                "logs": [
                    {
                        "category": "AppServiceHTTPLogs",
                        "enabled": true
                    },
                    {
                        "category": "AppServiceConsoleLogs",
                        "enabled": true
                    }
                ]
            },
            "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('appServiceName'))]"
            ]
        },
        {
            "type": "Microsoft.Network/loadBalancers",
            "apiVersion": "2022-07-01",
            "name": "[variables('lbName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "frontendIPConfigurations": [
                    {
                        "name": "frontendIP",
                        "properties": {
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetBackendName'))]"
                            }
                        }
                    }
                ],
                "backendAddressPools": [
                    {
                        "name": "backendPool"
                    }
                ],
                "loadBalancingRules": [
                    {
                        "name": "HTTPRule",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('lbName')), '/frontendIPConfigurations/frontendIP')]"
                            },
                            "backendAddressPool": {
                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('lbName')), '/backendAddressPools/backendPool')]"
                            },
                            "protocol": "Tcp",
                            "frontendPort": 80,
                            "backendPort": 80,
                            "probe": {
                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('lbName')), '/probes/httpProbe')]"
                            }
                        }
                    }
                ],
                "probes": [
                    {
                        "name": "httpProbe",
                        "properties": {
                            "protocol": "Http",
                            "port": 80,
                            "requestPath": "/",
                            "intervalInSeconds": 5,
                            "numberOfProbes": 2
                        }
                    }
                ]
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            ]
        },
        {
            "type": "Microsoft.Compute/virtualMachineScaleSets",
            "apiVersion": "2022-08-01",
            "name": "[variables('vmssName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard_B2s",
                "tier": "Standard",
                "capacity": 2
            },
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "overprovision": true,
                "upgradePolicy": {
                    "mode": "Manual"
                },
                "virtualMachineProfile": {
                    "storageProfile": {
                        "imageReference": {
                            "publisher": "Canonical",
                            "offer": "UbuntuServer",
                            "sku": "18.04-LTS",
                            "version": "latest"
                        },
                        "osDisk": {
                            "caching": "ReadWrite",
                            "createOption": "FromImage"
                        }
                    },
                    "osProfile": {
                        "computerNamePrefix": "vmss",
                        "adminUsername": "[parameters('adminUsername')]",
                        "adminPassword": "[parameters('adminPassword')]",
                        "linuxConfiguration": {
                            "disablePasswordAuthentication": false
                        }
                    },
                    "networkProfile": {
                        "networkInterfaceConfigurations": [
                            {
                                "name": "vmssNic",
                                "properties": {
                                    "primary": true,
                                    "ipConfigurations": [
                                        {
                                            "name": "ipconfig1",
                                            "properties": {
                                                "primary": true,
                                                "subnet": {
                                                    "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetBackendName'))]"
                                                },
                                                "loadBalancerBackendAddressPools": [
                                                    {
                                                        "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('lbName')), '/backendAddressPools/backendPool')]"
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/loadBalancers', variables('lbName'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            ]
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2022-04-01",
            "name": "[guid(variables('vmssName'), 'LogAnalyticsReader')]",
            "scope": "[variables('lawId')]",
            "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', '73c42c96-874c-492b-b04d-ab87d138a893')]",
                "principalId": "[reference(variables('vmssName'), '2022-08-01', 'Full').identity.principalId]"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('vmssName'))]"
            ]
        },
        {
            "type": "Microsoft.Network/applicationGateways",
            "apiVersion": "2022-07-01",
            "name": "[variables('agwName')]",
            "location": "[parameters('location')]",
            "properties": {
                "sku": {
                    "name": "WAF_v2",
                    "tier": "WAF_v2",
                    "capacity": 2
                },
                "gatewayIPConfigurations": [
                    {
                        "name": "appGatewayIpConfig",
                        "properties": {
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetAgwName'))]"
                            }
                        }
                    }
                ],
                "frontendIPConfigurations": [
                    {
                        "name": "appGatewayFrontendIP",
                        "properties": {
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipAgwName'))]"
                            }
                        }
                    }
                ],
                "frontendPorts": [
                    {
                        "name": "port80",
                        "properties": {
                            "port": 80
                        }
                    }
                ],
                "backendAddressPools": [
                    {
                        "name": "appServicePool"
                    },
                    {
                        "name": "vmssPool"
                    }
                ],
                "backendHttpSettingsCollection": [
                    {
                        "name": "httpSetting",
                        "properties": {
                            "port": 80,
                            "protocol": "Http",
                            "cookieBasedAffinity": "Disabled"
                        }
                    }
                ],
                "httpListeners": [
                    {
                        "name": "httpListener",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('agwName')), '/frontendIPConfigurations/appGatewayFrontendIP')]"
                            },
                            "frontendPort": {
                                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('agwName')), '/frontendPorts/port80')]"
                            },
                            "protocol": "Http"
                        }
                    }
                ],
                "urlPathMaps": [
                    {
                        "name": "routingPathMap",
                        "properties": {
                            "defaultBackendAddressPool": {
                                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('agwName')), '/backendAddressPools/appServicePool')]"
                            },
                            "defaultBackendHttpSettings": {
                                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('agwName')), '/backendHttpSettingsCollection/httpSetting')]"
                            },
                            "pathRules": [
                                {
                                    "name": "vmssRule",
                                    "properties": {
                                        "paths": [
                                            "/vmss/*"
                                        ],
                                        "backendAddressPool": {
                                            "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('agwName')), '/backendAddressPools/vmssPool')]"
                                        },
                                        "backendHttpSettings": {
                                            "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('agwName')), '/backendHttpSettingsCollection/httpSetting')]"
                                        }
                                    }
                                }
                            ]
                        }
                    }
                ],
                "requestRoutingRules": [
                    {
                        "name": "PathBasedRoutingRule",
                        "properties": {
                            "ruleType": "PathBasedRouting",
                            "priority": 100,
                            "httpListener": {
                                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('agwName')), '/httpListeners/httpListener')]"
                            },
                            "urlPathMap": {
                                "id": "[concat(resourceId('Microsoft.Network/applicationGateways', variables('agwName')), '/urlPathMaps/routingPathMap')]"
                            }
                        }
                    }
                ],
                "webApplicationFirewallConfiguration": {
                    "enabled": true,
                    "firewallMode": "Prevention",
                    "ruleSetType": "OWASP",
                    "ruleSetVersion": "3.2"
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipAgwName'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            ]
        },
        {
            "type": "Microsoft.Insights/diagnosticSettings",
            "apiVersion": "2021-05-01-preview",
            "scope": "[concat('Microsoft.Network/applicationGateways/', variables('agwName'))]",
            "name": "AGWLogs",
            "properties": {
                "workspaceId": "[variables('lawId')]",
                "logs": [
                    {
                        "category": "ApplicationGatewayAccessLog",
                        "enabled": true
                    },
                    {
                        "category": "ApplicationGatewayPerformanceLog",
                        "enabled": true
                    },
                    {
                        "category": "ApplicationGatewayFirewallLog",
                        "enabled": true
                    }
                ]
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/applicationGateways', variables('agwName'))]"
            ]
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2022-07-01",
            "name": "[variables('pipBastionName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "publicIPAllocationMethod": "Static"
            }
        },
        {
            "type": "Microsoft.Network/bastionHosts",
            "apiVersion": "2022-07-01",
            "name": "[variables('bastionName')]",
            "location": "[parameters('location')]",
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "IpConf",
                        "properties": {
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetBastionName'))]"
                            },
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipBastionName'))]"
                            }
                        }
                    }
                ]
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('pipBastionName'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
            ]
        }
    ]
}
